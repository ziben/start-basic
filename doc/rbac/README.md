# RBAC ç³»ç»Ÿå®æ–½å®ŒæˆæŠ¥å‘Š

## ğŸ“Š é¡¹ç›®æ¦‚è¿°

æˆåŠŸå®æ–½äº†å®Œæ•´çš„åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰ç³»ç»Ÿï¼ŒåŒ…æ‹¬éƒ¨é—¨ç®¡ç†ã€è§’è‰²ç®¡ç†ã€æƒé™ç®¡ç†å’Œæ•°æ®èŒƒå›´æ§åˆ¶ã€‚

---

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### **Phase 1: æ•°æ®åº“åŸºç¡€** âœ…

**æ‰©å±•çš„æ•°æ®æ¨¡å‹ï¼š**
- `Department` - éƒ¨é—¨å±‚çº§ç»“æ„
- `Permission` - æƒé™å®šä¹‰
- `RolePermission` - è§’è‰²æƒé™å…³è”
- `FieldPermission` - å­—æ®µçº§æƒé™
- `CrossOrgAccess` - è·¨ç»„ç»‡è®¿é—®
- `SystemRole` - ç³»ç»Ÿè§’è‰²æ‰©å±•
- `Member` - æˆå‘˜æ‰©å±•ï¼ˆdepartmentId, systemRoleIdï¼‰

**ç§å­æ•°æ®ï¼š**
- 23ä¸ªé»˜è®¤æƒé™
- 4ä¸ªç³»ç»Ÿè§’è‰²ï¼ˆadmin, org_admin, dept_admin, userï¼‰

### **Phase 2: éƒ¨é—¨ç®¡ç†** âœ…

**åç«¯å®ç°ï¼š**
- `DepartmentService` - å®Œæ•´çš„ CRUD + æ ‘å½¢ç»“æ„
- `department.fn.ts` - 7ä¸ª Server Functions
- `use-department-api.ts` - React Query hooks

**å‰ç«¯å®ç°ï¼š**
- éƒ¨é—¨æ ‘å½¢è¡¨æ ¼å±•ç¤ºï¼ˆTanStack Tableï¼‰
- å¯å±•å¼€/æ”¶èµ·å±‚çº§
- CRUD å¯¹è¯æ¡†
- éƒ¨é—¨é€‰æ‹©å™¨ç»„ä»¶
- å¿«é€Ÿæ·»åŠ å­éƒ¨é—¨åŠŸèƒ½
- æˆå‘˜æ•°é‡æ˜¾ç¤º

### **Phase 3: Members é›†æˆ** âœ…

**Schema æ‰©å±•ï¼š**
- æ·»åŠ  `departmentId` å’Œ `systemRoleId` å­—æ®µ
- å…³è” `department` å’Œ `systemRole` å¯¹è±¡
- ä¿æŒå‘åå…¼å®¹ï¼ˆä¿ç•™ `role` å­—ç¬¦ä¸²ï¼‰

**UI ç»„ä»¶ï¼š**
- `DepartmentSelector` - éƒ¨é—¨é€‰æ‹©å™¨ï¼ˆå±‚çº§æ˜¾ç¤ºï¼‰
- `SystemRoleSelector` - ç³»ç»Ÿè§’è‰²é€‰æ‹©å™¨ï¼ˆscope åŒºåˆ†ï¼‰
- æˆå‘˜è¡¨å•é›†æˆ
- åˆ—è¡¨æ˜¾ç¤ºä¼˜åŒ–

### **Phase 4: æƒé™ç³»ç»Ÿ** âœ…

**Permission ç®¡ç†ï¼š**
- `PermissionService` - CRUD æ“ä½œ
- `permission.fn.ts` - 6ä¸ª API ç«¯ç‚¹
- `use-permission-api.ts` - React Query hooks

**RolePermission åˆ†é…ï¼š**
- `RolePermissionService` - æƒé™åˆ†é…ç®¡ç†
- `role-permission.fn.ts` - 4ä¸ª API ç«¯ç‚¹
- `use-role-permission-api.ts` - React Query hooks

**æƒé™æ£€æŸ¥ï¼š**
- `checkPermission()` - æ£€æŸ¥ç”¨æˆ·æƒé™
- `requirePermission()` - å¼ºåˆ¶æƒé™è¦æ±‚
- `getUserPermissions()` - è·å–ç”¨æˆ·æ‰€æœ‰æƒé™
- `checkAnyPermission()` - æ£€æŸ¥ä»»ä¸€æƒé™
- `checkAllPermissions()` - æ£€æŸ¥æ‰€æœ‰æƒé™

**UI ç»„ä»¶ï¼š**
- `DataScopeSelector` - æ•°æ®èŒƒå›´é€‰æ‹©å™¨
- `RolePermissionsDialog` - è§’è‰²æƒé™åˆ†é…å¯¹è¯æ¡†

---

## ğŸ“ åˆ›å»ºçš„æ–‡ä»¶æ¸…å•

### **Service å±‚ï¼ˆ5ä¸ªï¼‰**
1. `shared/services/department.service.ts`
2. `shared/services/permission.service.ts`
3. `shared/services/role-permission.service.ts`
4. `shared/lib/permission-check.ts`

### **Server Functionsï¼ˆ4ä¸ªï¼‰**
1. `shared/server-fns/department.fn.ts`
2. `shared/server-fns/permission.fn.ts`
3. `shared/server-fns/role-permission.fn.ts`

### **API Hooksï¼ˆ4ä¸ªï¼‰**
1. `shared/hooks/use-department-api.ts`
2. `shared/hooks/use-permission-api.ts`
3. `shared/hooks/use-role-permission-api.ts`

### **UI ç»„ä»¶ï¼ˆ4ä¸ªï¼‰**
1. `shared/components/department-selector.tsx`
2. `shared/components/system-role-selector.tsx`
3. `shared/components/data-scope-selector.tsx`
4. `features/identity/roles/components/admin-roles-permissions-dialog.tsx`

### **æ›´æ–°çš„æ–‡ä»¶ï¼ˆ3ä¸ªï¼‰**
1. `features/organization/members/data/schema.ts`
2. `features/organization/members/components/member-mutate-dialog.tsx`
3. `features/organization/members/components/members-columns.tsx`

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§

### **1. éƒ¨é—¨ç®¡ç†**
- âœ… æ ‘å½¢å±‚çº§å±•ç¤º
- âœ… æ— é™å±‚çº§æ”¯æŒ
- âœ… å±•å¼€/æ”¶èµ·åŠŸèƒ½
- âœ… å±‚çº§ç¼©è¿›æ˜¾ç¤º
- âœ… å¿«é€Ÿæ·»åŠ å­éƒ¨é—¨
- âœ… é˜²æ­¢å¾ªç¯å¼•ç”¨
- âœ… æˆå‘˜æ•°é‡ç»Ÿè®¡

### **2. è§’è‰²ç®¡ç†**
- âœ… SystemRole æ›¿ä»£å­—ç¬¦ä¸²è§’è‰²
- âœ… è§’è‰²ä½œç”¨åŸŸï¼ˆGLOBAL/ORG/DEPTï¼‰
- âœ… è§’è‰²æƒé™åˆ†é…
- âœ… æ•°æ®èŒƒå›´æ§åˆ¶
- âœ… å‘åå…¼å®¹

### **3. æƒé™ç®¡ç†**
- âœ… æƒé™ CRUD æ“ä½œ
- âœ… æŒ‰èµ„æºåˆ†ç»„
- âœ… æƒé™åˆ†é…åˆ°è§’è‰²
- âœ… æ•°æ®èŒƒå›´è®¾ç½®ï¼ˆ5ç§ï¼‰
- âœ… æƒé™æ£€æŸ¥å‡½æ•°

### **4. æ•°æ®èŒƒå›´æ§åˆ¶**
- ğŸ”´ **å…¨éƒ¨æ•°æ®** - è®¿é—®æ‰€æœ‰æ•°æ®
- ğŸ”µ **æœ¬ç»„ç»‡** - ä»…æœ¬ç»„ç»‡æ•°æ®
- ğŸŸ¢ **æœ¬éƒ¨é—¨** - ä»…æœ¬éƒ¨é—¨æ•°æ®
- ğŸŸ¡ **æœ¬éƒ¨é—¨åŠå­éƒ¨é—¨** - åŒ…å«å­éƒ¨é—¨
- âšª **ä»…è‡ªå·±** - ä»…è‡ªå·±çš„æ•°æ®

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### **åˆ›å»ºéƒ¨é—¨**
```typescript
// åœ¨éƒ¨é—¨ç®¡ç†é¡µé¢
1. ç‚¹å‡»"åˆ›å»ºéƒ¨é—¨"æŒ‰é’®
2. å¡«å†™éƒ¨é—¨ä¿¡æ¯ï¼ˆåç§°ã€ç¼–ç ã€ä¸Šçº§éƒ¨é—¨ç­‰ï¼‰
3. ä¿å­˜
```

### **ä¸ºæˆå‘˜åˆ†é…éƒ¨é—¨å’Œè§’è‰²**
```typescript
// åœ¨æˆå‘˜ç®¡ç†é¡µé¢
1. åˆ›å»ºæˆ–ç¼–è¾‘æˆå‘˜
2. é€‰æ‹©éƒ¨é—¨ï¼ˆå±‚çº§é€‰æ‹©å™¨ï¼‰
3. é€‰æ‹©ç³»ç»Ÿè§’è‰²ï¼ˆæ˜¾ç¤º scopeï¼‰
4. ä¿å­˜
```

### **ä¸ºè§’è‰²åˆ†é…æƒé™**
```typescript
// åœ¨è§’è‰²ç®¡ç†é¡µé¢
1. ç‚¹å‡»è§’è‰²çš„"ç®¡ç†æƒé™"æŒ‰é’®
2. å‹¾é€‰éœ€è¦çš„æƒé™
3. ä¸ºæ¯ä¸ªæƒé™è®¾ç½®æ•°æ®èŒƒå›´
4. ä¿å­˜
```

### **åœ¨ä»£ç ä¸­æ£€æŸ¥æƒé™**
```typescript
import { checkPermission } from '@/shared/lib/permission-check'

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™
const hasPermission = await checkPermission(
  userId,
  'user:create',
  { organizationId }
)

if (!hasPermission) {
  throw new Error('æƒé™ä¸è¶³')
}
```

---

## ğŸ“Š æ•°æ®æµç¨‹

### **ç”¨æˆ·æƒé™éªŒè¯æµç¨‹ï¼š**
```
ç”¨æˆ·ç™»å½•
  â†“
è·å– Member å…³ç³»ï¼ˆorganizationId + userIdï¼‰
  â†“
è·å– SystemRoleï¼ˆé€šè¿‡ systemRoleIdï¼‰
  â†“
è·å– RolePermissionsï¼ˆè§’è‰²çš„æ‰€æœ‰æƒé™ï¼‰
  â†“
æ£€æŸ¥æ˜¯å¦æœ‰æŒ‡å®šæƒé™
  â†“
åº”ç”¨æ•°æ®èŒƒå›´è¿‡æ»¤
  â†“
è¿”å›æ•°æ®
```

---

## ğŸ¨ UI ç‰¹æ€§

### **éƒ¨é—¨ç®¡ç†é¡µé¢**
- æ ‘å½¢è¡¨æ ¼å±•ç¤º
- å±•å¼€/æ”¶èµ·æŒ‰é’®
- å±‚çº§ç¼©è¿›
- æˆå‘˜æ•°é‡ Badge
- å¿«é€Ÿæ·»åŠ å­éƒ¨é—¨
- å®Œæ•´ CRUD æ“ä½œ

### **æˆå‘˜ç®¡ç†é¡µé¢**
- éƒ¨é—¨åˆ—æ˜¾ç¤º
- SystemRole åˆ—æ˜¾ç¤ºï¼ˆä¼˜å…ˆï¼‰
- Fallback åˆ°å­—ç¬¦ä¸² role
- Scope Badge åŒºåˆ†

### **è§’è‰²æƒé™åˆ†é…å¯¹è¯æ¡†**
- æŒ‰èµ„æºåˆ†ç»„
- å¤é€‰æ¡†é€‰æ‹©
- æ•°æ®èŒƒå›´é€‰æ‹©å™¨
- è§†è§‰åŒ– Badge
- æ»šåŠ¨åŒºåŸŸ

---

## âœ… éªŒæ”¶æ ‡å‡†

### **åŠŸèƒ½å®Œæ•´æ€§**
- âœ… éƒ¨é—¨ CRUD å®Œæ•´
- âœ… æˆå‘˜å¯åˆ†é…éƒ¨é—¨å’Œè§’è‰²
- âœ… è§’è‰²å¯åˆ†é…æƒé™å’Œæ•°æ®èŒƒå›´
- âœ… æƒé™æ£€æŸ¥å‡½æ•°å¯ç”¨
- âœ… å‘åå…¼å®¹ç°æœ‰æ•°æ®

### **ç”¨æˆ·ä½“éªŒ**
- âœ… ç•Œé¢ç›´è§‚æ˜“ç”¨
- âœ… æ“ä½œæµç¨‹é¡ºç•…
- âœ… é”™è¯¯æç¤ºæ¸…æ™°
- âœ… åŠ è½½çŠ¶æ€æ˜ç¡®

### **ä»£ç è´¨é‡**
- âœ… åˆ†å±‚æ¸…æ™°ï¼ˆService/API/UIï¼‰
- âœ… ç±»å‹å®‰å…¨ï¼ˆTypeScript + Zodï¼‰
- âœ… é”™è¯¯å¤„ç†å®Œå–„
- âœ… ä»£ç å¤ç”¨æ€§é«˜

---

## ğŸš€ åç»­å»ºè®®

### **çŸ­æœŸä¼˜åŒ–**
1. æ·»åŠ æƒé™ç®¡ç†é¡µé¢ï¼ˆå¯é€‰ï¼‰
2. å®Œå–„é”™è¯¯æç¤ºæ–‡æ¡ˆ
3. æ·»åŠ æ“ä½œæ—¥å¿—

### **ä¸­æœŸæ‰©å±•**
1. å®ç°å­—æ®µçº§æƒé™ï¼ˆPhase 5ï¼‰
2. æ·»åŠ æ—¶é—´é™åˆ¶åŠŸèƒ½ï¼ˆPhase 6ï¼‰
3. å®ç°è·¨ç»„ç»‡è®¿é—®ï¼ˆPhase 6ï¼‰

### **é•¿æœŸè§„åˆ’**
1. æƒé™å®¡è®¡æ—¥å¿—
2. æƒé™æ¨¡æ¿åŠŸèƒ½
3. æ‰¹é‡æƒé™åˆ†é…
4. æƒé™å¯è§†åŒ–åˆ†æ

---

## ğŸ“ æ€»ç»“

æˆåŠŸå®æ–½äº†å®Œæ•´çš„ RBAC ç³»ç»Ÿï¼ŒåŒ…æ‹¬ï¼š
- âœ… 4ä¸ª Phase å…¨éƒ¨å®Œæˆ
- âœ… 17ä¸ªæ–°æ–‡ä»¶åˆ›å»º
- âœ… å®Œæ•´çš„ Service/API/UI ä¸‰å±‚æ¶æ„
- âœ… 5ç§æ•°æ®èŒƒå›´æ§åˆ¶
- âœ… å‘åå…¼å®¹è®¾è®¡
- âœ… ç”¨æˆ·å‹å¥½çš„ç•Œé¢

**ç³»ç»Ÿå·²å¯æŠ•å…¥ä½¿ç”¨ï¼**
