# PM2 è¿›ç¨‹ç®¡ç†

æœ¬é¡¹ç›®æ”¯æŒä¸¤ç§ç”Ÿäº§éƒ¨ç½²æ–¹å¼ï¼š

1. **ç›´æ¥ä½¿ç”¨Bunè¿è¡Œ**ï¼ˆç®€å•éƒ¨ç½²ï¼‰
2. **ä½¿ç”¨PM2ç®¡ç†**ï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹å¼1ï¼šBunç›´æ¥è¿è¡Œï¼ˆæ¨èå¼€å‘/ç®€å•éƒ¨ç½²ï¼‰

```bash
# æ„å»º
pnpm run build

# å¯åŠ¨
pnpm run start
```

### æ–¹å¼2ï¼šPM2ç®¡ç†ï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰

```bash
# å®‰è£…PM2ï¼ˆå…¨å±€æˆ–é¡¹ç›®ä¾èµ–ï¼‰
pnpm add -g pm2
# æˆ–ä½œä¸ºå¼€å‘ä¾èµ–
pnpm add -D pm2

# æ„å»º
pnpm run build

# å¯åŠ¨ï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰
pnpm run pm2:start

# å¯åŠ¨ï¼ˆå¼€å‘æ¨¡å¼ï¼Œå¸¦è¯¦ç»†æ—¥å¿—ï¼‰
pnpm run pm2:start:dev
```

## ğŸ“‹ PM2 å‘½ä»¤åˆ—è¡¨

| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `pnpm run pm2:start` | å¯åŠ¨åº”ç”¨ï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰ |
| `pnpm run pm2:start:dev` | å¯åŠ¨åº”ç”¨ï¼ˆå¼€å‘æ¨¡å¼ï¼‰ |
| `pnpm run pm2:stop` | åœæ­¢åº”ç”¨ |
| `pnpm run pm2:restart` | é‡å¯åº”ç”¨ï¼ˆæœ‰çŸ­æš‚åœæœºï¼‰ |
| `pnpm run pm2:reload` | **é›¶åœæœºé‡è½½**ï¼ˆæ¨èæ›´æ–°æ—¶ä½¿ç”¨ï¼‰ |
| `pnpm run pm2:delete` | åˆ é™¤åº”ç”¨è¿›ç¨‹ |
| `pnpm run pm2:logs` | æŸ¥çœ‹å®æ—¶æ—¥å¿— |
| `pnpm run pm2:monit` | ç›‘æ§CPU/å†…å­˜ä½¿ç”¨ |
| `pnpm run pm2:status` | æŸ¥çœ‹åº”ç”¨çŠ¶æ€ |
| `pnpm run pm2:save` | ä¿å­˜å½“å‰è¿›ç¨‹åˆ—è¡¨ |
| `pnpm run pm2:startup` | é…ç½®å¼€æœºè‡ªå¯åŠ¨ |

## ğŸ”§ PM2 é…ç½®è¯´æ˜

é…ç½®æ–‡ä»¶ï¼š`ecosystem.config.cjs`

### ä¸»è¦ç‰¹æ€§

- âœ… **é›†ç¾¤æ¨¡å¼**ï¼šé»˜è®¤ä½¿ç”¨æ‰€æœ‰CPUæ ¸å¿ƒï¼ˆ`instances: 'max'`ï¼‰
- âœ… **è‡ªåŠ¨é‡å¯**ï¼šåº”ç”¨å´©æºƒè‡ªåŠ¨é‡å¯
- âœ… **å†…å­˜é™åˆ¶**ï¼šè¶…è¿‡500MBè‡ªåŠ¨é‡å¯
- âœ… **é›¶åœæœºé‡è½½**ï¼šä½¿ç”¨ `pm2 reload` æ›´æ–°åº”ç”¨æ— åœæœº
- âœ… **æ—¥å¿—ç®¡ç†**ï¼šè‡ªåŠ¨è®°å½•åˆ° `logs/` ç›®å½•
- âœ… **ä¼˜é›…å…³é—­**ï¼šé…åˆ server.ts çš„ SIGTERM/SIGINT å¤„ç†

### è°ƒæ•´é›†ç¾¤å®ä¾‹æ•°

```bash
# ç¯å¢ƒå˜é‡æ–¹å¼
PM2_INSTANCES=2 pnpm run pm2:start

# æˆ–ä¿®æ”¹ ecosystem.config.cjs
instances: 2,  // æ”¹ä¸ºå›ºå®šæ•°é‡
```

### è‡ªå®šä¹‰é…ç½®

ç¼–è¾‘ `ecosystem.config.cjs` æ–‡ä»¶ï¼Œå¯ä»¥è°ƒæ•´ï¼š
- å†…å­˜é™åˆ¶ (`max_memory_restart`)
- æ—¥å¿—è·¯å¾„ (`error_file`, `out_file`)
- ç¯å¢ƒå˜é‡ (`env_production`, `env_development`)
- å®šæ—¶é‡å¯ (`cron_restart`)

## ğŸ“Š ç”Ÿäº§éƒ¨ç½²æµç¨‹

### é¦–æ¬¡éƒ¨ç½²

```bash
# 1. å…‹éš†ä»£ç 
git clone <repository-url>
cd zi-start-basic

# 2. å®‰è£…ä¾èµ–
pnpm install

# 3. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env è®¾ç½®ç”Ÿäº§ç¯å¢ƒé…ç½®

# 4. æ„å»ºåº”ç”¨
pnpm run build

# 5. å¯åŠ¨PM2
pnpm run pm2:start

# 6. ä¿å­˜è¿›ç¨‹åˆ—è¡¨ï¼ˆé‡å¯åæ¢å¤ï¼‰
pnpm run pm2:save

# 7. é…ç½®å¼€æœºè‡ªå¯åŠ¨
pnpm run pm2:startup
# ç„¶åæŒ‰ç…§æç¤ºæ‰§è¡Œè¾“å‡ºçš„å‘½ä»¤
```

### æ›´æ–°éƒ¨ç½²ï¼ˆé›¶åœæœºï¼‰

```bash
# 1. æ‹‰å–æœ€æ–°ä»£ç 
git pull

# 2. å®‰è£…ä¾èµ–ï¼ˆå¦‚æœ‰å˜æ›´ï¼‰
pnpm install

# 3. é‡æ–°æ„å»º
pnpm run build

# 4. é›¶åœæœºé‡è½½
pnpm run pm2:reload
```

## ğŸ–¥ï¸ ç›‘æ§ä¸è°ƒè¯•

### æŸ¥çœ‹å®æ—¶æ—¥å¿—
```bash
pnpm run pm2:logs
```

### ç›‘æ§èµ„æºä½¿ç”¨
```bash
pnpm run pm2:monit
```

### æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
```bash
pm2 show zi-start-basic
```

### æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹
```bash
pm2 list
```

## ğŸ› å¸¸è§é—®é¢˜

### Q: Windowsä¸‹PM2ä¸ç”Ÿæ•ˆï¼Ÿ
A: Windowsä¸‹PM2åŠŸèƒ½æœ‰é™ï¼Œæ¨èï¼š
- ä½¿ç”¨WSL2 + Linuxç¯å¢ƒ
- æˆ–ä½¿ç”¨Windows ServiceåŒ…è£…å™¨
- æˆ–ç›´æ¥ä½¿ç”¨ `bun run start`

### Q: å¦‚ä½•æ¸…ç†æ—¥å¿—ï¼Ÿ
```bash
pm2 flush  # æ¸…ç©ºæ‰€æœ‰æ—¥å¿—
```

### Q: å†…å­˜æŒç»­å¢é•¿æ€ä¹ˆåŠï¼Ÿ
è°ƒæ•´ `ecosystem.config.cjs` ä¸­çš„ `max_memory_restart` å€¼ï¼Œæˆ–å®šæ—¶é‡å¯ï¼š
```javascript
cron_restart: '0 4 * * *',  // æ¯å¤©å‡Œæ™¨4ç‚¹é‡å¯
```

### Q: é›†ç¾¤æ¨¡å¼ä¸‹æ•°æ®åº“è¿æ¥è¿‡å¤šï¼Ÿ
å‡å°‘å®ä¾‹æ•°é‡æˆ–ä½¿ç”¨è¿æ¥æ± ï¼š
```javascript
instances: 2,  // å‡å°‘å®ä¾‹
```

## ğŸ”— ç›¸å…³èµ„æº

- [PM2 å®˜æ–¹æ–‡æ¡£](https://pm2.keymetrics.io/)
- [Bun æ–‡æ¡£](https://bun.sh/docs)
- [TanStack Start æ–‡æ¡£](https://tanstack.com/start)

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **å¼€å‘ç¯å¢ƒ**ä¸å»ºè®®ä½¿ç”¨PM2ï¼Œç›´æ¥ç”¨ `pnpm dev` å³å¯
2. **Docker/K8sç¯å¢ƒ**ä¸éœ€è¦PM2ï¼Œå®¹å™¨æœ¬èº«æä¾›è¿›ç¨‹ç®¡ç†
3. ç¡®ä¿ `logs/` ç›®å½•æœ‰å†™å…¥æƒé™
4. ç”Ÿäº§ç¯å¢ƒå»ºè®®é…ç½®å¼€æœºè‡ªå¯åŠ¨
5. å®šæœŸæ£€æŸ¥æ—¥å¿—æ–‡ä»¶å¤§å°ï¼Œé¿å…ç£ç›˜å æ»¡
